import{useMemo as $,useImperativeHandle as W,forwardRef as G,useState as J,useEffect as K}from"react";import{useState as P,useEffect as U,useRef as C,useCallback as L}from"react";function _({url:i,credentials:m,background:w="#1E1E1E",viewOnly:h=!1,scaleViewport:g=!0,clipViewport:R=!0,resizeSession:T=!0,showDotCursor:x=!0,compressionLevel:k=2,qualityLevel:N=6,onConnect:D,onDisconnect:F,onError:E,onClipboard:V}){let y=C(null),s=C(null),a=C(null),[f,S]=P(!1),[M,d]=P(null),r=C(!0),c=C(!1),l=C(null),o=C(0),t=C(!1);U(()=>{typeof window<"u"&&!a.current&&import("@novnc/novnc/lib/rfb").then(e=>{a.current=e.default})},[]);let p=L(()=>{if(!c.current){if(c.current=!0,l.current&&(clearTimeout(l.current),l.current=null),s.current){let e=s.current;s.current=null;try{["connect","disconnect","credentialsrequired","securityfailure","clipboard"].forEach(u=>{let v=e._eventListeners?.[u];Array.isArray(v)&&[...v].forEach(H=>{try{e.removeEventListener(u,H)}catch{}})})}catch{}try{let n=e._sock?._websocket;n?.readyState===WebSocket.OPEN&&n.close(1e3,"Normal closure")}catch{}try{e.disconnect()}catch{}}c.current=!1}},[]),b=L(()=>{!y.current||!i||!r.current||t.current||c.current||!a.current||(t.current=!0,setTimeout(()=>{if(!r.current||!y.current||!a.current){t.current=!1;return}try{let e=new a.current(y.current,i,{credentials:{username:m?.username||"",password:m?.password||"",target:m?.target||""},shared:!0});e.viewOnly=h,e.scaleViewport=g,e.clipViewport=R,e.resizeSession=T,e.background=w,e.compressionLevel=k,e.qualityLevel=N,e.showDotCursor=x,e.focusOnClick=!0,e.addEventListener("connect",(()=>{if(!r.current){try{e.disconnect()}catch{}t.current=!1;return}S(!0),d(null),o.current=0,t.current=!1,D?.()})),e.addEventListener("clipboard",(n=>{let u=n.detail;!r.current||!u?.text||(V?.(u.text),navigator.clipboard?.writeText&&navigator.clipboard.writeText(u.text).catch(()=>{}))})),e.addEventListener("disconnect",(n=>{let u=n.detail;if(!r.current){t.current=!1;return}if(S(!1),F?.(u?.clean??!0),u?.clean===!1&&r.current&&o.current<5){let v=Math.min(1e3*Math.pow(1.5,o.current)+Math.random()*300,8e3);l.current=setTimeout(()=>{r.current&&!c.current?(o.current++,t.current=!1,s.current&&p(),setTimeout(()=>r.current&&b(),100)):t.current=!1},v),d(`Reconnecting... (${o.current+1}/5)`)}else u?.clean===!1&&(d("Connection lost"),E?.("Connection lost")),t.current=!1})),e.addEventListener("securityfailure",(n=>{let u=n.detail;if(!r.current){t.current=!1;return}let v=u?.reason||`Code ${u?.status||"unknown"}`;v.includes("Resize is administratively prohibited")||(d(`Security failure: ${v}`),E?.(`Security failure: ${v}`)),t.current=!1})),e.addEventListener("credentialsrequired",(()=>{if(!r.current){t.current=!1;return}d("Credentials required"),E?.("Credentials required"),t.current=!1})),s.current=e,setTimeout(()=>{if(s.current&&y.current){window.dispatchEvent(new Event("resize"));let n=y.current.querySelector("canvas");n&&(n.style.width="100%",n.style.height="100%")}},500)}catch(e){if(!r.current){t.current=!1;return}let n=e instanceof Error?e.message:"Unknown error";d(`Connection error: ${n}`),E?.(n),t.current=!1,o.current<3&&r.current&&(l.current=setTimeout(()=>{r.current&&!c.current&&(o.current++,b())},2e3*Math.pow(1.3,o.current)))}},c.current?200:50))},[i,m,w,h,g,R,T,x,k,N,D,F,E,V,p]);U(()=>{r.current=!0;let e=setTimeout(()=>{a.current&&i&&r.current?b():!a.current&&typeof window<"u"&&import("@novnc/novnc/lib/rfb").then(n=>{a.current=n.default,i&&r.current&&b()})},100);return()=>{if(r.current=!1,clearTimeout(e),l.current&&clearTimeout(l.current),s.current){try{s.current._sock?._websocket?.close(1e3,"Normal closure"),s.current.disconnect()}catch{}s.current=null}c.current=!1,t.current=!1}},[i,m,b,p]);let z=L(()=>{c.current||t.current||(o.current=0,d(null),p(),setTimeout(()=>r.current&&b(),200))},[b,p]),O=L(e=>{if(s.current&&f&&e)try{return s.current.clipboardPasteFrom(e),!0}catch{}return!1},[f]),A=L(async()=>{if(s.current&&f)try{let e=await navigator.clipboard.readText();if(e)return s.current.clipboardPasteFrom(e),!0}catch{}return!1},[f]);return{vncRef:y,isConnected:f,error:M,reconnect:z,disconnect:p,sendClipboard:O,pasteFromClipboard:A}}import{jsx as q}from"react/jsx-runtime";var B=G(({instanceId:i,password:m,readOnly:w=!1,background:h="#1E1E1E",className:g,style:R,scaleViewport:T=!0,clipViewport:x=!0,resizeSession:k=!0,showDotCursor:N=!0,compressionLevel:D=2,qualityLevel:F=6,onConnect:E,onDisconnect:V,onError:y,onClipboard:s},a)=>{let[f,S]=J(!1);K(()=>{S(!0)},[]);let M=$(()=>f?`wss://${i}.orgo.dev/websockify`:"",[i,f]),d=$(()=>({username:"user",password:m,target:`${i}.orgo.dev`}),[i,m]),{vncRef:r,isConnected:c,reconnect:l,disconnect:o,sendClipboard:t,pasteFromClipboard:p}=_({url:M,credentials:d,background:h,viewOnly:w,scaleViewport:T,clipViewport:x,resizeSession:k,showDotCursor:N,compressionLevel:D,qualityLevel:F,onConnect:E,onDisconnect:V,onError:y,onClipboard:s});return W(a,()=>({reconnect:l,disconnect:o,sendClipboard:t,pasteFromClipboard:p,isConnected:c}),[l,o,t,p,c]),f?q("div",{ref:r,className:g,style:{width:"100%",height:"100%",background:h,pointerEvents:w?"none":"auto",cursor:w?"default":"none",opacity:c?1:0,transition:"opacity 0.3s ease-in-out",...R}}):q("div",{className:g,style:{width:"100%",height:"100%",background:h,...R}})});B.displayName="ComputerDisplay";export{B as ComputerDisplay,_ as useVNC};
//# sourceMappingURL=index.mjs.map