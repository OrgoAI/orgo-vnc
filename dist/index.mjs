import{useMemo as U,useImperativeHandle as W,forwardRef as O}from"react";import{useState as S,useEffect as A,useRef as C,useCallback as g}from"react";import H from"@novnc/novnc/lib/rfb";function M({url:i,credentials:f,background:E="#1E1E1E",viewOnly:b=!1,scaleViewport:w=!0,clipViewport:R=!0,resizeSession:T=!0,showDotCursor:x=!0,compressionLevel:L=2,qualityLevel:N=6,onConnect:k,onDisconnect:D,onError:m,onClipboard:F}){let d=C(null),s=C(null),[y,V]=S(!1),[_,l]=S(null),t=C(!0),u=C(!1),a=C(null),o=C(0),r=C(!1),v=g(()=>{if(!u.current){if(u.current=!0,a.current&&(clearTimeout(a.current),a.current=null),s.current){let e=s.current;s.current=null;try{["connect","disconnect","credentialsrequired","securityfailure","clipboard"].forEach(c=>{let p=e._eventListeners?.[c];Array.isArray(p)&&[...p].forEach(z=>{try{e.removeEventListener(c,z)}catch{}})})}catch{}try{let n=e._sock?._websocket;n?.readyState===WebSocket.OPEN&&n.close(1e3,"Normal closure")}catch{}try{e.disconnect()}catch{}}u.current=!1}},[]),h=g(()=>{!d.current||!i||!t.current||r.current||u.current||(r.current=!0,setTimeout(()=>{if(!t.current||!d.current){r.current=!1;return}try{let e=new H(d.current,i,{credentials:{username:f?.username||"",password:f?.password||"",target:f?.target||""},shared:!0});e.viewOnly=b,e.scaleViewport=w,e.clipViewport=R,e.resizeSession=T,e.background=E,e.compressionLevel=L,e.qualityLevel=N,e.showDotCursor=x,e.focusOnClick=!0,e.addEventListener("connect",(()=>{if(!t.current){try{e.disconnect()}catch{}r.current=!1;return}V(!0),l(null),o.current=0,r.current=!1,k?.()})),e.addEventListener("clipboard",(n=>{let c=n.detail;!t.current||!c?.text||(F?.(c.text),navigator.clipboard?.writeText&&navigator.clipboard.writeText(c.text).catch(()=>{}))})),e.addEventListener("disconnect",(n=>{let c=n.detail;if(!t.current){r.current=!1;return}if(V(!1),D?.(c?.clean??!0),c?.clean===!1&&t.current&&o.current<5){let p=Math.min(1e3*Math.pow(1.5,o.current)+Math.random()*300,8e3);a.current=setTimeout(()=>{t.current&&!u.current?(o.current++,r.current=!1,s.current&&v(),setTimeout(()=>t.current&&h(),100)):r.current=!1},p),l(`Reconnecting... (${o.current+1}/5)`)}else c?.clean===!1&&(l("Connection lost"),m?.("Connection lost")),r.current=!1})),e.addEventListener("securityfailure",(n=>{let c=n.detail;if(!t.current){r.current=!1;return}let p=c?.reason||`Code ${c?.status||"unknown"}`;p.includes("Resize is administratively prohibited")||(l(`Security failure: ${p}`),m?.(`Security failure: ${p}`)),r.current=!1})),e.addEventListener("credentialsrequired",(()=>{if(!t.current){r.current=!1;return}l("Credentials required"),m?.("Credentials required"),r.current=!1})),s.current=e,setTimeout(()=>{if(s.current&&d.current){window.dispatchEvent(new Event("resize"));let n=d.current.querySelector("canvas");n&&(n.style.width="100%",n.style.height="100%")}},500)}catch(e){if(!t.current){r.current=!1;return}let n=e instanceof Error?e.message:"Unknown error";l(`Connection error: ${n}`),m?.(n),r.current=!1,o.current<3&&t.current&&(a.current=setTimeout(()=>{t.current&&!u.current&&(o.current++,h())},2e3*Math.pow(1.3,o.current)))}},u.current?200:50))},[i,f,E,b,w,R,T,x,L,N,k,D,m,F,v]);A(()=>{t.current=!0,v();let e=setTimeout(()=>i&&t.current&&h(),100);return()=>{if(t.current=!1,clearTimeout(e),a.current&&clearTimeout(a.current),s.current){try{s.current._sock?._websocket?.close(1e3,"Normal closure"),s.current.disconnect()}catch{}s.current=null}u.current=!1,r.current=!1}},[i,f,h,v]);let B=g(()=>{u.current||r.current||(o.current=0,l(null),v(),setTimeout(()=>t.current&&h(),200))},[h,v]),P=g(e=>{if(s.current&&y&&e)try{return s.current.clipboardPasteFrom(e),!0}catch{}return!1},[y]),q=g(async()=>{if(s.current&&y)try{let e=await navigator.clipboard.readText();if(e)return s.current.clipboardPasteFrom(e),!0}catch{}return!1},[y]);return{vncRef:d,isConnected:y,error:_,reconnect:B,disconnect:v,sendClipboard:P,pasteFromClipboard:q}}import{jsx as G}from"react/jsx-runtime";var $=O(({instanceId:i,password:f,readOnly:E=!1,background:b="#1E1E1E",className:w,style:R,scaleViewport:T=!0,clipViewport:x=!0,resizeSession:L=!0,showDotCursor:N=!0,compressionLevel:k=2,qualityLevel:D=6,onConnect:m,onDisconnect:F,onError:d,onClipboard:s},y)=>{let V=U(()=>`wss://${i}.orgo.dev/websockify`,[i]),_=U(()=>({username:"user",password:f,target:`${i}.orgo.dev`}),[i,f]),{vncRef:l,isConnected:t,reconnect:u,disconnect:a,sendClipboard:o,pasteFromClipboard:r}=M({url:V,credentials:_,background:b,viewOnly:E,scaleViewport:T,clipViewport:x,resizeSession:L,showDotCursor:N,compressionLevel:k,qualityLevel:D,onConnect:m,onDisconnect:F,onError:d,onClipboard:s});return W(y,()=>({reconnect:u,disconnect:a,sendClipboard:o,pasteFromClipboard:r,isConnected:t}),[u,a,o,r,t]),G("div",{ref:l,className:w,style:{width:"100%",height:"100%",background:b,pointerEvents:E?"none":"auto",cursor:E?"default":"none",opacity:t?1:0,transition:"opacity 0.3s ease-in-out",...R}})});$.displayName="ComputerDisplay";export{$ as ComputerDisplay,M as useVNC};
//# sourceMappingURL=index.mjs.map